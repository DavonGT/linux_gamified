<!DOCTYPE html>
{% load static %}
<html>
<head>
    <title>Linux Gamified</title>
    <link rel="stylesheet" href="{% static 'game/css/base.css' %}">
    <link rel="stylesheet" href="{% static 'game/css/game.css' %}">
    <style>
        .feedback.incorrect {
            color: #ff0000;
            font-weight: bold;
        }
        .game-over {
            color: #ff0000;
            font-size: 2em;
            font-weight: bold;
            text-align: center;
            margin-top: 50px;
        }
    </style>
</head>
<body>
    <div id="header">
        {% if time != None %}
            <p id="timer">Time Left: <span id="time-value">{{ time }}</span>s</p>
        {% endif %}
        {% if mode == 'survival' %}
            <p id="survival_score">Score: {{ survival_score }}</p>
        {% elif mode == 'time_attack' %}
            <p id="time_attack_score">Score: {{ time_attack_score }}</p>
        {% elif mode == 'hardcore_survival' %}
            <p id="ha_score">Score: {{ ha_score }}</p>
        {% elif mode == 'hardcore_time_attack' %}
            <p id="hta_score">Score: {{ hta_score }}</p>
        {% endif %}

        {% if lives != None %}
            <p id="lives">Lives: <span id="lives-value">{{ lives }}</span></p>
        {% endif %}
    </div>
    <div id="terminal">
        <p><strong>Task:</strong> {{ question.task }}</p>
        <div id="prompt">
            <span>{{ player }}@linux-gamified:~$</span>
            <input type="hidden" id="question_id" value="{{ question.id }}">
            <input type="text" id="user_command" 
                   placeholder="Type your command here" 
                   autocomplete="off" 
                   autofocus>
        </div>
        <div id="feedback-container">
            <p id="feedback" class="feedback"></p>
            <p id="game-over-message" class="game-over" style="display: none;">GAME OVER</p>
        </div>
        <div class="g-u-button">
            <a href='{% url "game_over" %}' class="give-up">Give Up?</a>
        </div>
    </div>

    <script>
        // Game state
        const gameState = {
            timer: null,
            timeLeft: {{ time|default_if_none:0 }},
            mode: "{{ mode }}",
            csrfToken: "{{ csrf_token }}",
            isGameOver: false
        };

        // DOM elements
        const elements = {
            timer: document.getElementById('time-value'),
            survival_score: document.getElementById('survival_score'),
            time_attack_score: document.getElementById('time_attack_score'),
            hs_score: document.getElementById('hs_score'),
            hta_score: document.getElementById('hta_score'),
            lives: document.getElementById('lives-value'),
            userCommand: document.getElementById('user_command'),
            feedback: document.getElementById('feedback'),
            gameOverMsg: document.getElementById('game-over-message'),
            terminal: document.getElementById('terminal')
        };

        // Initialize game
        function initGame() {
            if (gameState.timeLeft > 0) {
                startTimer();
            }
            setupEventListeners();
        }

        function startTimer() {
            gameState.timer = setInterval(() => {
                gameState.timeLeft--;
                elements.timer.textContent = gameState.timeLeft;
                
                if (gameState.timeLeft <= 0) {
                    clearInterval(gameState.timer);
                    handleTimeUp();
                }
            }, 1000);
        }

        function setupEventListeners() {
            elements.userCommand.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !gameState.isGameOver) {
                    submitAnswer();
                }
            });
        }

        async function submitAnswer() {
            if (gameState.isGameOver) return;
            
            const command = elements.userCommand.value.trim();
            if (!command) return;

            disableInput();
            
            try {
                const response = await fetch('/validate/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': gameState.csrfToken
                    },
                    body: JSON.stringify({
                        question_id: document.getElementById('question_id').value,
                        user_command: command,
                        current_time: gameState.timeLeft
                    })
                });
                
                const data = await response.json();
                handleResponse(data);
            } catch (error) {
                console.error('Error:', error);
                showFeedback("An error occurred", 'error');
                enableInput();
            }
        }

        function handleResponse(data) {
            if (data.result === 'correct') {
                handleCorrectAnswer(data);
            } else if (data.result === 'incorrect') {
                handleIncorrectAnswer(data);
            } else if (data.result === 'game_over') {
                handleGameOver(data);
            }
        }

        function handleCorrectAnswer(data) {
            showFeedback('Correct!', 'success');
            setTimeout(() => {
                location.reload();
            }, 1000);
            
        }

        function handleIncorrectAnswer(data) {
            showFeedback('Incorrect!', 'incorrect');
            if (elements.lives && data.lives !== undefined) {
                elements.lives.textContent = data.lives;
            }
            setTimeout(() => {
                elements.userCommand.value = '';
                enableInput();
            }, 1000);
        }

        function handleGameOver(data) {
            gameState.isGameOver = true;
            clearInterval(gameState.timer);
            elements.feedback.style.display = 'none';
            elements.gameOverMsg.style.display = 'block';
            if (elements.lives) {
                elements.lives.textContent = '0';
            }
            disableInput();
            
            setTimeout(() => {
                location.href = '/game_over/';
            }, 2000);
        }

        function handleTimeUp() {
            fetch('/time_up/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': gameState.csrfToken
                },
                body: JSON.stringify({ current_time: gameState.timeLeft })
            })
            .then(response => response.json())
            .then(data => {
                if (data.result === 'game_over') {
                    handleGameOver(data);
                }
            })
            .catch(console.error);
        }

        function disableInput() {
            elements.userCommand.disabled = true;
        }

        function enableInput() {
            elements.userCommand.disabled = false;
            elements.userCommand.focus();
        }

        function showFeedback(message, type) {
            elements.feedback.textContent = message;
            elements.feedback.className = `feedback ${type}`;
            elements.feedback.style.display = 'block';
        }

        document.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>